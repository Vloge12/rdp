name: Remote Desktop Colab
on:  
  workflow_dispatch:
    inputs:
      remote_code:
        description: 'Enter Chrome Remote Desktop Code'
        required: true
        type: string
      email:
        description: 'Enter Email for GetScreen.me registration'
        required: true
        type: string

jobs:
  build:
    name: Start RDP, Install Software, Register Email, and Setup Audio
    runs-on: windows-latest

    steps:
      - name: Print Email Input
        run: |
          echo "Email Address: ${{ github.event.inputs.email }}"

      - name: Install GetScreen.me
        shell: pwsh
        run: |
          Write-Output "üì• Downloading GetScreen.me..."
          $url = "https://getscreen.me/download/getscreen.msi"
          $msiPath = "$env:TEMP\\getscreen.msi"
          Invoke-WebRequest -Uri $url -OutFile $msiPath

          Write-Output "üì¶ Installing GetScreen.me..."
          Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn /norestart" -Wait

          $exePath = "${env:ProgramFiles}\\GetScreen.me\\getscreen.exe"
          if (Test-Path $exePath) {
            Write-Output "üîë Registering GetScreen.me with email..."
            Start-Process -FilePath $exePath -ArgumentList "-install -register ${{ github.event.inputs.email }} -hidden -no-gui"
            Start-Sleep -Seconds 10
            Start-Service -Name "GetScreen" -ErrorAction SilentlyContinue
            Set-Service -Name "GetScreen" -StartupType Automatic -ErrorAction SilentlyContinue
            Write-Output "‚úÖ GetScreen.me installed and registered successfully."
          } else {
            Write-Error "‚ùå GetScreen.exe not found after install!"
          }

      - name: Install Chrome Remote Desktop Host
        shell: pwsh
        run: |
          $msiUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $msiPath = "$env:TEMP\chromeremotedesktophost.msi"
          Invoke-WebRequest -Uri $msiUrl -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn" -Wait

      - name: Start Chrome Remote Desktop Session
        shell: pwsh
        run: |
          $code = "${{ github.event.inputs.remote_code }}"
          $redirect = "https://remotedesktop.google.com/_/oauthredirect"
          $exePath = "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          Start-Process -FilePath "$exePath" -ArgumentList "--code=$code --redirect-url=$redirect --name=$env:COMPUTERNAME --pin=123456" -Wait

      - name: Optimization (Resolution + Dark Mode + Black Wallpaper)
        shell: pwsh
        run: |
          # Set resolution
          curl.exe -L -o "$env:TEMP\nircmd.zip" "https://www.nirsoft.net/utils/nircmd.zip"
          Expand-Archive -Path "$env:TEMP\nircmd.zip" -DestinationPath "$env:TEMP\nircmd" -Force
          & "$env:TEMP\nircmd\nircmd.exe" setdisplay 1366 768 32

          # Force dark mode
          $ThemePath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize"
          if (-not (Test-Path $ThemePath)) { New-Item -Path $ThemePath -Force }
          Set-ItemProperty -Path $ThemePath -Name "AppsUseLightTheme" -Value 0
          Set-ItemProperty -Path $ThemePath -Name "SystemUsesLightTheme" -Value 0

          # Black wallpaper
          Add-Type -AssemblyName System.Drawing
          $bmp = New-Object System.Drawing.Bitmap(1920,1080)
          $g = [System.Drawing.Graphics]::FromImage($bmp); $g.Clear([System.Drawing.Color]::Black)
          $wall = "$env:TEMP\black.bmp"; $bmp.Save($wall); $g.Dispose(); $bmp.Dispose()
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "Wallpaper" -Value $wall
          Set-ItemProperty -Path "HKCU:\Control Panel\Colors" -Name "Background" -Value "0 0 0"

          $api = @'
          using System.Runtime.InteropServices;
          public class UI {
            [DllImport("user32.dll", CharSet = CharSet.Auto)]
            public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
          }
          '@
          Add-Type -TypeDefinition $api
          [UI]::SystemParametersInfo(20, 0, $wall, 3)

          Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          Start-Process explorer.exe
          Write-Output "‚úÖ Environment optimized."

      - name: Fast Software Installation (IDM, WinRAR, VPN, Discord)
        shell: pwsh
        run: |
          # WinRAR
          curl.exe -L -o "$env:TEMP\winrar.exe" "https://www.rarlab.com/rar/winrar-x64-712.exe"
          Start-Process "$env:TEMP\winrar.exe" "/S" -Wait
          
          # IDM
          curl.exe -L -o "$env:TEMP\idm.exe" "https://mirror2.internetdownloadmanager.com/idman642build41.exe"
          Start-Process "$env:TEMP\idm.exe" "/skipdlgs" -Wait
          $idm = "${env:ProgramFiles(x86)}\Internet Download Manager\IDMan.exe"
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "IDMan" -Value "`"$idm`" /onstartup"
          Start-Process $idm "/onstartup"

          # VPN Gate
          $vpnURL = "https://www.dropbox.com/scl/fo/a6c0sqactnwr26cbbv1uc/APO1J80osQpo_8EoBOU3eJA?rlkey=s7wgg6ieuhlkr7wlxa9j9yij6&dl=1"
          curl.exe -L -o "$env:TEMP\vpn.zip" $vpnURL
          Expand-Archive "$env:TEMP\vpn.zip" "$env:USERPROFILE\Desktop\vpn" -Force
          Start-Process "cmd.exe" "/c install_vpngate.bat" -WorkingDirectory "$env:USERPROFILE\Desktop\vpn"

          # Discord
          curl.exe -L "https://discord.com/api/downloads/distributions/app/installers/latest?channel=stable&platform=win&arch=x64" -o "$env:TEMP\discord.exe"
          Start-Process "$env:TEMP\discord.exe" "/S"

      - name: Final Setup (Tor + Audio + Loop)
        shell: pwsh
        run: |
          # Tor Browser
          curl.exe -L -o "$env:TEMP\tor.zip" "https://www.dropbox.com/scl/fi/faraacel5x4ssj5clo2j1/Browser.zip?rlkey=81rsd6nbwk2p95e0t3mpcirfi&st=3pnv7hia&dl=1"
          Expand-Archive "$env:TEMP\tor.zip" "$env:USERPROFILE\browser" -Force

          $s = New-Object -ComObject WScript.Shell
          $t = $s.CreateShortcut("$env:USERPROFILE\Desktop\Tor.lnk")
          $t.TargetPath = "$env:USERPROFILE\browser\Browser\firefox.exe"; $t.Save()
          $d = $s.CreateShortcut("$env:USERPROFILE\Desktop\Discord.lnk")
          $d.TargetPath = "$env:LOCALAPPDATA\Discord\Update.exe"
          $d.Arguments = "--processStart Discord.exe"; $d.Save()

          # Virtual Audio (VB-Cable)
          curl.exe -L -o "$env:TEMP\vb.zip" "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip"
          Expand-Archive "$env:TEMP\vb.zip" "$env:TEMP\vb" -Force
          Start-Process "$env:TEMP\vb\VBCABLE_Setup_x64.exe" "-i -h" -Wait
          Start-Service "AudioSrv", "AudioEndpointBuilder"

          # Run Loop
          git clone https://github.com/Alex15969/Loop "$env:TEMP\Loop"
          cd "$env:TEMP\Loop"; cmd /c loop.bat
